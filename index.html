<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ボリューミー店長ミニゲーム</title>
<style>
  :root{
    --bg:#97d2e4; --ink:#0c2a33; --muted:#215b6b; --white:#fff;
    --pill:#e6f7fd; --btn:#10aee3; --btn-ink:#fff; --card:#ffffffef;
    --win:#0da66e; --lose:#d94848;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif
  }
  .wrap{min-height:100dvh;display:flex;flex-direction:column;align-items:center}
  .container{width:min(880px,92vw);margin:0 auto;padding:16px 0 24px}

  h1{margin:8px 0 4px;font-size:clamp(22px,5.8vw,36px);letter-spacing:.06em;text-align:center}
  .sub{margin:0 0 10px;color:var(--muted);text-align:center;font-size:clamp(12px,3.4vw,15px)}
  .score{margin:12px 0 6px;text-align:center;font-weight:800;font-size:clamp(22px,7.2vw,34px)}
  .message{margin:8px 0 18px;text-align:center;font-size:clamp(14px,4.2vw,18px)}
  .pill{display:inline-block;padding:.45em 1em;border-radius:999px;background:var(--pill);
    font-weight:700;color:#222;font-size:clamp(12px,3.8vw,16px)}
  .btnrow{display:flex;gap:14px;justify-content:center;align-items:center;margin:10px 0 0;position:relative;z-index:5}
  .btn{appearance:none;border:none;border-radius:14px;cursor:pointer;font-weight:800;letter-spacing:.06em}
  .btn.primary{background:var(--btn);color:var(--btn-ink);padding:14px 22px;font-size:clamp(14px,4.8vw,18px)}
  .btn.ghost{background:transparent;color:#083b48;border:2px solid #083b4840;
    padding:12px 20px;border-radius:16px;font-size:clamp(14px,4.8vw,18px)}

  /* ===== タイトル ===== */
  #title{display:grid;place-items:center}
  #title .hero{width:100%;display:flex;flex-direction:column;align-items:center;gap:12px;margin-top:8px}
  #title h2{margin:0;text-align:center;line-height:1.25;font-size:clamp(22px,6.2vw,34px)}
  .title-illus{
    width:min(620px,92vw);max-height:62svh;object-fit:contain;object-position:center bottom;
    display:block;margin:8px auto 2px; pointer-events:none;
  }
  .title-note{margin:12px 0 0;text-align:center;color:#083b48aa;font-size:clamp(12px,3.6vw,15px)}
  .speech{display:none;margin:2px auto 0;padding:.6em 1em;border-radius:12px;
    background:#fff; box-shadow:0 8px 24px rgba(0,0,0,.12); font-weight:800; text-align:center}

  /* ===== ジャンケン ===== */
  #game{display:none}
  .topRow{
    margin-top:4px;display:flex;align-items:flex-start;justify-content:space-between;gap:clamp(10px,4vw,18px)
  }
  .frameBox{
    position:relative;flex:0 0 auto;
    width:clamp(160px,40vw,320px);aspect-ratio:3/4;
    background:url("frame2.png") center/contain no-repeat;
  }
  .bossHandImg{
    position:absolute;left:8%;top:6%;width:84%;height:88%;
    object-fit:contain;filter:drop-shadow(0 10px 16px #00000018);
  }
  .bossPic{
    flex:0 0 auto;width:clamp(200px,42vw,360px);height:auto;object-fit:contain;
    filter:drop-shadow(0 10px 20px rgba(0,0,0,.12))
  }
  .hands{margin:16px auto 0;display:flex;justify-content:center;gap:clamp(12px,4vw,18px)}
  .handBtn{
    width:clamp(92px,22vw,136px);aspect-ratio:1/1;border-radius:18px;background:var(--white);
    box-shadow:0 10px 30px #075a6a22;display:grid;place-items:center;
    font-size:clamp(34px,10vw,52px);cursor:pointer;border:none
  }
  .resultCard{display:none;margin:12px auto 0;max-width:720px;background:var(--card);
    border-radius:16px;padding:12px 14px;text-align:center;font-size:clamp(14px,4.4vw,18px);box-shadow:0 12px 28px #07495926}
  .restartRow{display:none;justify-content:center;margin:14px 0 0}
  .win{color:var(--win);font-weight:800}.lose{color:var(--lose);font-weight:800}

  /* ===== 神経衰弱（正方形カード） ===== */
  #memory{display:none}
  .memHud{
    display:flex; gap:14px; justify-content:center; align-items:center;
    margin: 10px 0 10px; font-weight:700; flex-wrap:wrap;
  }
  .memGrid{
    --gap: clamp(10px, 3.4vw, 14px);
    display:grid; gap: var(--gap);
    grid-template-columns: repeat(4, 1fr); /* 8枚=2行、12枚=3行 */
    width:min(740px, 92vw); margin: 0 auto;
  }
  .memCard{ aspect-ratio: 1 / 1; perspective: 1000px; position:relative; }
  .memInner{
    position:absolute; inset:0; transition: transform .42s ease;
    transform-style: preserve-3d;
    transform: rotateY(180deg);              /* 初期は裏面 */
  }
  .memInner.flipped{ transform: rotateY(0deg); } /* めくると表面 */
  .memFace{
    position:absolute; inset:0; border-radius:16px; overflow:hidden;
    backface-visibility:hidden; box-shadow:0 10px 24px rgba(0,0,0,.12);
    display:grid; place-items:center;
  }
  .memFace.front{ background:#fff; transform: rotateY(0deg); }       /* 表：絵柄 */
  .memFace.back{
    background: linear-gradient(135deg, #c9f0ff, #97d2e4);
    color:#084357; font-size: clamp(22px, 6.4vw, 28px);
    transform: rotateY(180deg);                                       /* 裏：ロゴ */
  }
  .memFace.front img{ width: 78%; height: 78%; object-fit: contain; pointer-events:none; }
  .memInner.matched{ animation: pop .36s ease; }
  @keyframes pop{ 0%{ transform: rotateY(0deg) scale(1)} 50%{ transform: rotateY(0deg) scale(1.06)} 100%{ transform: rotateY(0deg) scale(1)} }

  /* ライフ表示（神経衰弱） */
  .lives{ display:flex; gap:6px; align-items:center; font-size:clamp(18px,5.4vw,22px) }
  .lives .heart{ transition: .2s ease; }
  .lives .heart.lost{ opacity:.3; filter:grayscale(1); transform:scale(.92); }

  /* 難易度ボタン */
  .memDiff{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin: 6px 0 6px; }

  /* ===== アイス合成パズル（2048系） ===== */
  .scoopHud{display:flex;gap:16px;justify-content:center;align-items:center;flex-wrap:wrap;font-weight:800;margin:8px 0}
  .scoopHud span{background:#ffffffcc;padding:8px 12px;border-radius:10px;box-shadow:0 6px 16px #00000012}
  .scoopBtns{display:flex;gap:10px}

  /* ▼ responsive 盤＆フォント（ここが追加/改善点） */
  .scoopBoard{
    --cols:4; --gap:10px; --pad:10px; --tile:80px;           /* JSで --tile を更新 */
    width:min(520px,92vw); margin:12px auto 0; position:relative;
  }
  .scGrid,
  .scTiles{
    display:grid;
    grid-template-columns: repeat(var(--cols), var(--tile));
    gap: var(--gap);
    padding: var(--pad);
    border-radius:14px;
  }
  .scGrid{ background:#bde3ef; }
  .scGrid .cell{ width:var(--tile); height:var(--tile); border-radius:10px; background:#e6f7fd }
  .scTiles{ position:absolute; inset:0 }

  .tile{
    width:var(--tile); height:var(--tile);
    border-radius:12px; display:grid; place-items:center;
    font-weight:900; text-align:center; line-height:1.1;
    box-shadow:0 10px 24px rgba(0,0,0,.12); user-select:none;
    animation: tileIn .18s ease; color:#083b48;
  }
  .tile b{ display:block; font-size: calc(var(--tile) * .42); } /* 基本はマスに比例 */
  .tile.big  b{ font-size: calc(var(--tile) * .36); }  /* 3桁 */
  .tile.huge b{ font-size: calc(var(--tile) * .30); }  /* 4桁以上 */

  @keyframes tileIn{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
  .tile.merge{animation: mergePop .22s ease}
  @keyframes mergePop{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
  .t2{background:#fffdf5}.t4{background:#fff6da}
  .t8{background:#ffe1e9}.t16{background:#f6d7c7}
  .t32{background:#d8f0dc}.t64{background:#d7f0fb}
  .t128{background:#ffe9c2}.t256{background:#f7d9ff}
  .t512{background:#d9fff1}.t1024{background:#fff0c5}.t2048{background:#ffe7e7}
  .tileImg{ width:86%; height:86%; object-fit:contain; pointer-events:none; }

  /* ▼ 矢印パッド */
  .dirPad{ display:grid; grid-template-columns:repeat(3,64px); grid-template-rows:repeat(3,64px);
    gap:10px; justify-content:center; margin:16px 0 0; }
  .dirPad .spacer{ visibility:hidden }
  .dirBtn{
    font-size:22px; font-weight:900; border:none; cursor:pointer;
    border-radius:14px; background:#ffffffcc; box-shadow:0 8px 18px #00000012;
  }
  .dirBtn:active{ transform:translateY(1px) }
  @media (max-width:420px){
    .dirPad{ grid-template-columns:repeat(3,56px); grid-template-rows:repeat(3,56px); gap:8px }
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- ===== タイトル ===== -->
    <div class="container" id="title">
      <div class="hero">
        <span class="pill" id="titlePill">めちゃつよっ！</span>
        <h2>ボリューミー店長との<br>じゃんけん対決！</h2>
        <img id="titleImg" class="title-illus" src="title-start2.png" alt="店長ポーズ">
        <div id="speech" class="speech">俺の強さに怖気づいたかっ！</div>
        <div class="btnrow">
          <button class="btn primary" id="btnStart">挑戦する</button>
          <button class="btn ghost"   id="btnQuit"  data-mode="quit">あきらめる</button>
        </div>
        <div class="btnrow">
          <button class="btn ghost" id="btnMem">神経衰弱で遊ぶ</button>
        </div>
        <div class="btnrow">
          <button class="btn ghost" id="btnScoop">アイス合成パズルで遊ぶ</button>
        </div>
        <p class="title-note">めちゃつよ店長に勝利しよう！</p>
      </div>
    </div>

    <!-- ===== ジャンケン ===== -->
    <div class="container" id="game">
      <div class="topRow">
        <div class="frameBox">
          <img id="bossHandImg" class="bossHandImg" src="rock2.png" alt="店長の手">
        </div>
        <img class="bossPic" src="boss2.png" alt="店長">
      </div>

      <h1>～店長とジャンケン勝負～</h1>
      <p class="sub">先に3回勝った方が勝ち！</p>

      <div class="score" id="score">あなた 0 - 店長 0</div>
      <div class="message" id="message">手を選んでね！</div>

      <div class="hands" id="hands">
        <button class="handBtn" data-hand="rock"     aria-label="グー">✊</button>
        <button class="handBtn" data-hand="scissors" aria-label="チョキ">✌️</button>
        <button class="handBtn" data-hand="paper"    aria-label="パー">✋</button>
      </div>

      <div class="resultCard" id="resultCard"></div>
      <div class="restartRow" id="restartRow">
        <button class="btn ghost" id="restartBtn">再挑戦</button>
      </div>

      <div class="btnrow" style="margin-top:12px">
        <button class="btn ghost" id="backToTitle1">タイトルへ戻る</button>
      </div>
    </div>

    <!-- ===== 神経衰弱（🩵ライフ3／難易度） ===== -->
    <div class="container" id="memory">
      <h1>〜神経衰弱〜</h1>
      <p class="sub">同じアイスを2枚めくってペアを作ろう！</p>

      <div class="memDiff">
        <button class="btn primary" id="memEasyBtn">やさしい</button>
        <button class="btn ghost"   id="memHardBtn">むずかしい</button>
      </div>

      <div class="memHud" id="memHud" style="display:none">
        <span id="memMoves">手数: 0</span>
        <span id="memPairs">ペア: 0 / 4</span>
        <span class="lives" id="memLives" title="ライフ">
          <span class="heart">🩵</span><span class="heart">🩵</span><span class="heart">🩵</span>
        </span>
        <button class="btn ghost" id="memRetry">もう一回</button>
      </div>

      <div class="memGrid" id="memGrid" aria-label="カードの場"></div>

      <div class="resultCard" id="memResult" style="display:none; margin-top:14px"></div>

      <div class="btnrow" style="margin-top:10px">
        <button class="btn ghost" id="memBack">タイトルへ戻る</button>
      </div>
    </div>

    <!-- ===== アイス合成パズル（2048系） ===== -->
    <div class="container" id="scoop" style="display:none">
      <h1>〜2048パズル〜</h1>
      <p class="sub">同じ数字を合体させて高ランクを目指そう</p>

      <div class="scoopHud">
        <span id="scScore">スコア: 0</span>
        <span id="scBest">ベスト: 0</span>
        <div class="scoopBtns">
          <button class="btn ghost" id="scUndo">1手戻る</button>
          <button class="btn ghost" id="scRetry">もう一回</button>
        </div>
      </div>

      <div class="scoopBoard" id="boardWrap">
        <div class="scGrid" id="scGridBg"></div>
        <div class="scTiles" id="scTiles"></div>
      </div>

      <!-- ▼ 矢印パッド -->
      <div class="dirPad" aria-label="方向ボタン">
        <span class="spacer"></span>
        <button class="dirBtn" id="padUp">↑</button>
        <span class="spacer"></span>
        <button class="dirBtn" id="padLeft">←</button>
        <button class="dirBtn" id="padDown">↓</button>
        <button class="dirBtn" id="padRight">→</button>
      </div>

      <div class="resultCard" id="scResult" style="display:none; margin-top:14px"></div>

      <div class="btnrow" style="margin-top:10px">
        <button class="btn ghost" id="scBack">タイトルへ戻る</button>
      </div>
    </div>
  </div>

<script>
  /* ===== タイトル：あきらめる → セリフ表示 & 1回だけ「挑戦する」に変化 ===== */
  const titleView = document.getElementById('title');
  const gameView  = document.getElementById('game');
  const memView   = document.getElementById('memory');
  const scoopView = document.getElementById('scoop');

  const titleImg  = document.getElementById('titleImg');
  const speech    = document.getElementById('speech');
  const btnStart  = document.getElementById('btnStart');
  const btnQuit   = document.getElementById('btnQuit');
  const btnMem    = document.getElementById('btnMem');
  const btnScoop  = document.getElementById('btnScoop');

  btnQuit.addEventListener('click', () => {
    if (btnQuit.dataset.mode === 'quit') {
      speech.style.display = 'block';
      titleImg.src = 'title-quit2.png';
      btnQuit.textContent = '挑戦する';
      btnQuit.dataset.mode = 'start';
      btnQuit.classList.remove('ghost');
      btnQuit.classList.add('primary');
    } else {
      startGame();
    }
  });
  btnStart.addEventListener('click', startGame);
  btnMem.addEventListener('click', ()=> showMemoryMenu());
  btnScoop.addEventListener('click', showScoop);

  function showTitle(){
    gameView.style.display='none';
    memView.style.display='none';
    scoopView.style.display='none';
    titleView.style.display='block';
    speech.style.display='none';
    titleImg.src = 'title-start2.png';
    btnQuit.textContent = 'あきらめる';
    btnQuit.dataset.mode = 'quit';
    btnQuit.classList.add('ghost');
    btnQuit.classList.remove('primary');
    window.scrollTo({top:0, behavior:'smooth'});
  }

  /* =======================
     ジャンケン（完成版）
     ======================= */
  function startGame(){
    titleView.style.display = 'none';
    gameView.style.display  = 'block';
    resetGame();
    window.scrollTo({top:0,behavior:'smooth'});
  }

  const WIN_TARGET = 3;
  const BOSS_EDGE  = 0.70; // 店長ちょい強め

  const scoreEl    = document.getElementById('score');
  const messageEl  = document.getElementById('message');
  const handsWrap  = document.getElementById('hands');
  const resultCard = document.getElementById('resultCard');
  const restartRow = document.getElementById('restartRow');
  const bossHandImg= document.getElementById('bossHandImg');

  let score = { you:0, boss:0 };
  const IMG    = { rock:'rock2.png', scissors:'scissors2.png', paper:'paper2.png' };
  const WINMAP = { rock:'scissors', scissors:'paper', paper:'rock' };

  function resetGame(){
    score.you = 0; score.boss = 0;
    updateScore();
    messageEl.textContent = '手を選んでね！';
    bossHandImg.src = IMG.rock;
    resultCard.style.display = 'none';
    restartRow.style.display = 'none';
    handsWrap.style.display = 'flex';
  }
  function updateScore(){ scoreEl.textContent = `あなた ${score.you} - 店長 ${score.boss}`; }

  function bossPick(player){
    const beat = ({rock:'paper', paper:'scissors', scissors:'rock'})[player]; // 店長が勝つ手
    const lose = WINMAP[player]; // プレイヤーが勝つ手
    const tie  = player;
    if (Math.random() < BOSS_EDGE) return beat;
    return [lose, tie][Math.random()<0.5 ? 0 : 1];
  }

  function play(player){
    if (handsWrap.style.display === 'none') return;
    const boss = bossPick(player);
    bossHandImg.src = IMG[boss];

    if (player === boss){
      messageEl.textContent = 'あいこ！次の手を選んでね';
    }else if (WINMAP[player] === boss){
      score.you++; updateScore();
      messageEl.innerHTML = `<span class="win">あなたの勝ち！</span> 次の手を選んでね`;
    }else{
      score.boss++; updateScore();
      messageEl.innerHTML = `<span class="lose">店長の勝ち！</span> 次の手を選んでね`;
    }
    checkFinish();
  }

  function checkFinish(){
    if (score.you >= WIN_TARGET || score.boss >= WIN_TARGET){
      handsWrap.style.display = 'none';
      resultCard.style.display = 'block';
      restartRow.style.display = 'flex';
      if (score.you >= WIN_TARGET){
        resultCard.innerHTML = `<strong>🎉 あなたの勝ち！</strong><div style="margin-top:6px">おめでとう！</div>`;
      }else{
        resultCard.innerHTML = `<strong>👑 店長の勝ち！</strong><div style="margin-top:6px">また挑戦してね！</div>`;
      }
    }
  }

  document.querySelectorAll('.handBtn').forEach(b=>b.addEventListener('click', ()=>play(b.dataset.hand)));
  document.getElementById('restartBtn').addEventListener('click', resetGame);
  document.getElementById('backToTitle1').addEventListener('click', showTitle);

  /* =======================
     神経衰弱（🩵ライフ3＋難易度）
     ======================= */
  const USE_ICE_IMAGES = true; // ice1〜ice6 を使う（無いものは絵文字）
  const ICE_SET = [
    { img:'ice1.png', emoji:'🍨', name:'プレーン' },
    { img:'ice2.png', emoji:'🍫', name:'チョコ' },
    { img:'ice3.png', emoji:'🍵', name:'そのぎ茶' },
    { img:'ice4.png', emoji:'🔔', name:'ちりんちりんくん' },
    { img:'ice5.png', emoji:'👨', name:'店長1' },
    { img:'ice6.png', emoji:'🧑', name:'店長2' }
  ];

  const memGrid   = document.getElementById('memGrid');
  const memHud    = document.getElementById('memHud');
  const memMoves  = document.getElementById('memMoves');
  const memPairs  = document.getElementById('memPairs');
  const memRetry  = document.getElementById('memRetry');
  const memBack   = document.getElementById('memBack');
  const memResult = document.getElementById('memResult');
  const memLives  = document.getElementById('memLives');
  const memEasyBtn= document.getElementById('memEasyBtn');
  const memHardBtn= document.getElementById('memHardBtn');

  const MAX_LIVES = 3;
  let TYPES_COUNT = 4; // 4 or 6
  let memDeck = []; // {id}
  let first = null, second = null, lock = false;
  let pairs = 0, moves = 0;
  let lives = MAX_LIVES;
  let memOver = false;

  function showMemoryMenu(){
    titleView.style.display='none';
    gameView.style.display='none';
    scoopView.style.display='none';
    memView.style.display='block';
    memHud.style.display = 'none';
    memGrid.innerHTML = '';
    memResult.style.display = 'none';
    window.scrollTo({top:0, behavior:'smooth'});
  }

  memEasyBtn.addEventListener('click', ()=> startMemory(4));
  memHardBtn.addEventListener('click', ()=> startMemory(6));

  function startMemory(types=4){
    TYPES_COUNT = types;
    buildMemDeck();
    renderMem();
    pairs = 0; moves = 0; lock = false; first = second = null;
    memOver = false;
    lives = MAX_LIVES;
    updateMemHud();
    renderLives();
    memResult.style.display = 'none';
    memHud.style.display = 'flex';
    window.scrollTo({top:0, behavior:'smooth'});
  }

  function updateMemHud(){
    memMoves.textContent = `手数: ${moves}`;
    memPairs.textContent = `ペア: ${pairs} / ${TYPES_COUNT}`;
  }
  function renderLives(){
    const hearts = memLives.querySelectorAll('.heart');
    hearts.forEach((h,i)=> h.classList.toggle('lost', i >= lives));
  }
  function buildMemDeck(){
    memDeck = [];
    for(let i=0;i<TYPES_COUNT;i++){ memDeck.push({id:i}); memDeck.push({id:i}); }
    for(let i=memDeck.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [memDeck[i], memDeck[j]] = [memDeck[j], memDeck[i]];
    }
  }
  function renderMem(){
    memGrid.innerHTML = '';
    memDeck.forEach((card, idx)=>{
      const c = document.createElement('div');
      c.className = 'memCard';
      c.dataset.index = idx;

      const inner = document.createElement('div');
      inner.className = 'memInner';
      inner.setAttribute('role','button');
      inner.setAttribute('aria-label','カードをめくる');

      const front = document.createElement('div'); // 表：絵柄
      front.className = 'memFace front';

      const img = document.createElement('img');
      img.src = ICE_SET[card.id].img;
      img.alt = ICE_SET[card.id].name;

      const emoji = document.createElement('span');
      emoji.textContent = ICE_SET[card.id].emoji;
      emoji.style.fontSize = 'clamp(32px, 10vw, 56px)';

      img.addEventListener('load', ()=> { emoji.style.display='none'; });
      img.addEventListener('error',()=> { img.style.display='none'; });

      front.appendChild(img);
      front.appendChild(emoji);

      const back = document.createElement('div'); // 裏：共通デザイン
      back.className = 'memFace back';
      back.textContent = '🍨';

      inner.appendChild(front);
      inner.appendChild(back);
      c.appendChild(inner);
      memGrid.appendChild(c);

      c.addEventListener('click', ()=> flipMem(idx, inner));
    });
  }

  function flipMem(idx, innerEl){
    if (memOver || lock) return;
    if (innerEl.classList.contains('flipped')) return;

    innerEl.classList.add('flipped'); // 裏→表
    if (!first){
      first = { idx, id: memDeck[idx].id, el: innerEl };
      navigator.vibrate?.(15);
      return;
    }
    // 2枚目
    second = { idx, id: memDeck[idx].id, el: innerEl };
    lock = true; moves++; updateMemHud();

    if (first.id === second.id){
      setTimeout(()=>{
        first.el.classList.add('matched');
        second.el.classList.add('matched');
        pairs++; updateMemHud();
        first = second = null; lock = false;

        if (pairs >= TYPES_COUNT){
          memOver = true;
          memResult.style.display = 'block';
          memResult.innerHTML = `<strong>🎉 ぜんぶそろった！</strong><div style="margin-top:6px">おめでとう！</div>`;
        }
        navigator.vibrate?.([20,40,20]);
      }, 220);
    }else{
      lives = Math.max(0, lives - 1);
      renderLives();

      setTimeout(()=>{
        first.el.classList.remove('flipped');
        second.el.classList.remove('flipped');
        first = second = null;
        lock = false;
        navigator.vibrate?.(30);

        if (lives <= 0 && !memOver){
          memOver = true;
          memResult.style.display = 'block';
          memResult.innerHTML = `<strong>💥 おしまい！</strong><div style="margin-top:6px">また挑戦してね！</div>`;
        }
      }, 700);
    }
  }

  memRetry.addEventListener('click', ()=> startMemory(TYPES_COUNT));
  memBack.addEventListener('click', showTitle);

  /* =======================
     アイス合成パズル（2048系）
     ======================= */
  function showScoop(){
    titleView.style.display='none';
    gameView.style.display='none';
    memView.style.display='none';
    scoopView.style.display='block';
    setupScoop();
    window.scrollTo({top:0,behavior:'smooth'});
  }
  document.getElementById('scBack').addEventListener('click', showTitle);

  const scGridBg = document.getElementById('scGridBg');
  const scTiles  = document.getElementById('scTiles');
  const scScore  = document.getElementById('scScore');
  const scBest   = document.getElementById('scBest');
  const scUndo   = document.getElementById('scUndo');
  const scRetry  = document.getElementById('scRetry');
  const scResult = document.getElementById('scResult');
  const boardWrap= document.getElementById('boardWrap');

  // 2〜64は数値表示、128〜は画像（無ければ数字にフォールバック）
  const FLAVORS = { 2:{name:'2'}, 4:{name:'4'}, 8:{name:'8'}, 16:{name:'16'}, 32:{name:'32'}, 64:{name:'64'} };
  const IMAGE_LABEL = { 128:'屋台', 256:'アイス', 512:'店長', 1024:'店長キメポーズ', 2048:'社長' };

  let board = [];       // 16長配列（0=空）
  let scoreNow = 0;
  let best = Number(localStorage.getItem('scoop_best') || 0);
  let prevState = null; // undo用

  function setupScoop(){
    if (!scGridBg.childElementCount){
      for(let i=0;i<16;i++){ const c=document.createElement('div'); c.className='cell'; scGridBg.appendChild(c); }
    }
    best = Number(localStorage.getItem('scoop_best') || 0);
    scoreNow = 0; board = new Array(16).fill(0); prevState=null;
    spawn(); spawn();
    setBoardTileSize();  // ← 盤サイズに合わせて--tile更新
    draw();
    scResult.style.display='none';
  }

  // 盤幅から1マスのpxを算出して --tile に反映（リサイズ対応）
  function setBoardTileSize(){
    const wrapW = boardWrap.clientWidth;    // .scoopBoard の幅
    const gap=10, pad=10, cols=4;
    const tile = Math.floor( (wrapW - pad*2 - gap*(cols-1)) / cols );
    boardWrap.style.setProperty('--tile', tile+'px');
  }
  window.addEventListener('resize', setBoardTileSize);

  function spawn(){
    const zeros = board.map((v,i)=>v===0?i:null).filter(v=>v!==null);
    if (!zeros.length) return false;
    const pos = zeros[Math.floor(Math.random()*zeros.length)];
    board[pos] = Math.random()<0.9 ? 2 : 4;
    return true;
  }
  function canMove(){
    if (board.includes(0)) return true;
    for (let r=0;r<4;r++) for(let c=0;c<4;c++){
      const i=r*4+c, v=board[i];
      if (c<3 && board[i+1]===v) return true;
      if (r<3 && board[i+4]===v) return true;
    }
    return false;
  }
  function lineMove(line){
    let arr = line.filter(v=>v!==0);
    let scoreGain = 0;
    for(let i=0;i<arr.length-1;i++){
      if (arr[i]!==0 && arr[i]===arr[i+1]){
        arr[i]*=2; scoreGain += arr[i]; arr[i+1]=0; i++;
      }
    }
    arr = arr.filter(v=>v!==0);
    while(arr.length<4) arr.push(0);
    return {line:arr, gain:scoreGain};
  }
  function move(dir){
    const before = board.slice();
    prevState = {board: before.slice(), score: scoreNow};
    let totalGain = 0;

    if (dir==='L' || dir==='R'){
      for(let r=0;r<4;r++){
        let row = board.slice(r*4, r*4+4);
        if (dir==='R') row.reverse();
        const {line,gain} = lineMove(row);
        totalGain += gain;
        if (dir==='R') line.reverse();
        for(let c=0;c<4;c++) board[r*4+c]=line[c];
      }
    } else {
      for(let c=0;c<4;c++){
        let col = [board[c],board[c+4],board[c+8],board[c+12]];
        if (dir==='D') col.reverse();
        const {line,gain} = lineMove(col);
        totalGain += gain;
        if (dir==='D') line.reverse();
        [board[c],board[c+4],board[c+8],board[c+12]] = line;
      }
    }

    if (board.join('') === before.join('')){ prevState = null; return; }
    scoreNow += totalGain;
    if (scoreNow>best){ best=scoreNow; localStorage.setItem('scoop_best', String(best)); }
    spawn();
    draw();
    checkState();
  }

  function checkState(){
    const maxTile = Math.max(...board);
    if (maxTile >= 2048){
      scResult.style.display='block';
      scResult.innerHTML = `<strong>🎉 2048達成！${IMAGE_LABEL[2048] || ''}</strong><div style="margin-top:6px">おめでとう！</div>`;
    } else {
      scResult.style.display='none';
    }
    if (!canMove()){
      scResult.style.display='block';
      scResult.innerHTML = `<strong>💥 おしまい！</strong><div style="margin-top:6px">スコア ${scoreNow}（ベスト ${best}） また挑戦してね！</div>`;
    }
  }

  function draw(){
    scTiles.innerHTML='';
    for(let i=0;i<16;i++){
      const v = board[i];
      if (!v) { const ph = document.createElement('div'); scTiles.appendChild(ph); continue; }
      const t = document.createElement('div');
      t.className = `tile t${v}`;

      const digits = String(v).length;
      if (digits===3) t.classList.add('big');
      if (digits>=4)  t.classList.add('huge');

      if (v >= 128){
        const img = document.createElement('img');
        img.className = 'tileImg';
        img.src = `puzzle${v}.png`;
        img.alt = IMAGE_LABEL[v] || String(v);
        img.addEventListener('error', ()=>{
          img.remove();
          t.innerHTML = `<b>${v}</b>`;
        });
        t.appendChild(img);
      } else {
        t.innerHTML = `<b>${v}</b>`;
      }

      scTiles.appendChild(t);
    }
    scScore.textContent = `スコア: ${scoreNow}`;
    scBest.textContent  = `ベスト: ${best}`;
  }

  // 入力（キーボード・スワイプ・矢印パッド）
  window.addEventListener('keydown', (e)=>{
    if (scoopView.style.display!=='block') return;
    const k=e.key;
    if (k==='ArrowLeft') move('L');
    else if (k==='ArrowRight') move('R');
    else if (k==='ArrowUp') move('U');
    else if (k==='ArrowDown') move('D');
  });
  let touchStartX=0, touchStartY=0;
  scTiles.addEventListener('touchstart', (e)=>{ const t=e.touches[0]; touchStartX=t.clientX; touchStartY=t.clientY; }, {passive:true});
  scTiles.addEventListener('touchend', (e)=>{
    const t=e.changedTouches[0]; const dx=t.clientX-touchStartX, dy=t.clientY-touchStartY;
    const ax=Math.abs(dx), ay=Math.abs(dy), TH=24;
    if (ax<TH && ay<TH) return;
    if (ax>ay) move(dx>0?'R':'L'); else move(dy>0?'D':'U');
  }, {passive:true});

  document.getElementById('scUndo').addEventListener('click', ()=>{
    if (!prevState) return;
    board = prevState.board.slice(); scoreNow = prevState.score; prevState=null; draw(); scResult.style.display='none';
  });
  document.getElementById('scRetry').addEventListener('click', setupScoop);

  // 矢印パッド
  document.getElementById('padUp').addEventListener('click', ()=>move('U'));
  document.getElementById('padLeft').addEventListener('click', ()=>move('L'));
  document.getElementById('padDown').addEventListener('click', ()=>move('D'));
  document.getElementById('padRight').addEventListener('click', ()=>move('R'));
</script>
</body>
</html>
