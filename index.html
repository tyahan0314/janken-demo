<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ボリューミー店長ミニゲーム</title>

<!-- =========================
     スタイル（レイアウト・色）
     ========================= -->
<style>
  :root{
    /* サイト全体の色 */
    --bg:#97d2e4; --ink:#0c2a33; --muted:#215b6b; --white:#fff;
    --pill:#e6f7fd; --btn:#10aee3; --btn-ink:#fff; --card:#ffffffef;
    --win:#0da66e; --lose:#d94848;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif
  }
  .wrap{min-height:100dvh;display:flex;flex-direction:column;align-items:center}
  .container{width:min(920px,92vw);margin:0 auto;padding:16px 0 28px}

  /* 共通見出し */
  h1{margin:8px 0 4px;font-size:clamp(22px,5.8vw,36px);letter-spacing:.06em;text-align:center}
  .sub{margin:0 0 10px;color:var(--muted);text-align:center;font-size:clamp(12px,3.4vw,15px)}
  .score{margin:12px 0 6px;text-align:center;font-weight:800;font-size:clamp(22px,7.2vw,34px)}
  .message{margin:8px 0 18px;text-align:center;font-size:clamp(14px,4.2vw,18px)}

  /* ボタン系 */
  .pill{display:inline-block;padding:.45em 1em;border-radius:999px;background:var(--pill);
    font-weight:700;color:#222;font-size:clamp(12px,3.8vw,16px)}
  .btnrow{display:flex;gap:14px;justify-content:center;align-items:center;margin:10px 0 0;position:relative;z-index:5;flex-wrap:wrap}
  .btn{appearance:none;border:none;border-radius:14px;cursor:pointer;font-weight:800;letter-spacing:.06em}
  .btn.primary{background:var(--btn);color:var(--btn-ink);padding:14px 22px;font-size:clamp(14px,4.8vw,18px)}
  .btn.ghost{background:transparent;color:#083b48;border:2px solid #083b4840;
    padding:12px 20px;border-radius:16px;font-size:clamp(14px,4.8vw,18px)}

  /* ===== タイトル画面 ===== */
  #title{display:grid;place-items:center}
  #title .hero{width:100%;display:flex;flex-direction:column;align-items:center;gap:12px;margin-top:8px}
  #title h2{margin:0;text-align:center;line-height:1.25;font-size:clamp(22px,6.2vw,34px)}
  .title-illus{
    width:min(620px,92vw);max-height:62svh;object-fit:contain;object-position:center bottom;
    display:block;margin:8px auto 2px; pointer-events:none;
  }
  .title-note{margin:12px 0 0;text-align:center;color:#083b48aa;font-size:clamp(12px,3.6vw,15px)}
  .speech{display:none;margin:2px auto 0;padding:.6em 1em;border-radius:12px;
    background:#fff; box-shadow:0 8px 24px rgba(0,0,0,.12); font-weight:800; text-align:center}

  /* ===== じゃんけん ===== */
  #game{display:none}
  .topRow{
    margin-top:4px;display:flex;align-items:flex-start;justify-content:space-between;gap:clamp(10px,4vw,18px)
  }
  .frameBox{
    /* 左上：店長の手を入れる額縁 */
    position:relative;flex:0 0 auto;
    width:clamp(160px,40vw,320px);aspect-ratio:3/4;
    background:url("frame2.png") center/contain no-repeat;
  }
  .bossHandImg{
    /* 額縁の内側に、店長の手画像（グー/チョキ/パー）をフィットさせる */
    position:absolute;left:8%;top:6%;width:84%;height:88%;
    object-fit:contain;filter:drop-shadow(0 10px 16px #00000018);
  }
  .bossPic{
    /* 右上：店長の写真 */
    flex:0 0 auto;width:clamp(200px,42vw,360px);height:auto;object-fit:contain;
    filter:drop-shadow(0 10px 20px rgba(0,0,0,.12))
  }
  .hands{margin:16px auto 0;display:flex;justify-content:center;gap:clamp(12px,4vw,18px)}
  .handBtn{
    /* プレイヤーの✊✌️✋ボタン（画像でなく絵文字） */
    width:clamp(92px,22vw,136px);aspect-ratio:1/1;border-radius:18px;background:var(--white);
    box-shadow:0 10px 30px #075a6a22;display:grid;place-items:center;
    font-size:clamp(34px,10vw,52px);cursor:pointer;border:none
  }
  .resultCard{display:none;margin:12px auto 0;max-width:720px;background:var(--card);
    border-radius:16px;padding:12px 14px;text-align:center;font-size:clamp(14px,4.4vw,18px);box-shadow:0 12px 28px #07495926}
  .restartRow{display:none;justify-content:center;margin:14px 0 0}
  .win{color:var(--win);font-weight:800}.lose{color:var(--lose);font-weight:800}

  /* ===== 神経衰弱（ソロ） ===== */
  #memory{display:none}
  .memDiff{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin: 6px 0 6px; }
  .memHud{
    display:flex; gap:14px; justify-content:center; align-items:center;
    margin: 10px 0 10px; font-weight:700; flex-wrap:wrap;
  }
  .memGrid{
    --gap: clamp(10px, 3.4vw, 14px);
    display:grid; gap: var(--gap);
    grid-template-columns: repeat(4, 1fr);
    width:min(740px, 92vw); margin: 0 auto;
  }
  .memCard{ aspect-ratio: 1 / 1; perspective: 1000px; position:relative; }
  .memInner{
    position:absolute; inset:0; transition: transform .42s ease;
    transform-style: preserve-3d;
    transform: rotateY(180deg);
  }
  .memInner.flipped{ transform: rotateY(0deg); }
  .memFace{
    position:absolute; inset:0; border-radius:16px; overflow:hidden;
    backface-visibility:hidden; box-shadow:0 10px 24px rgba(0,0,0,.12);
    display:grid; place-items:center;
  }
  .memFace.front{ background:#fff; transform: rotateY(0deg); }
  .memFace.back{
    background: linear-gradient(135deg, #c9f0ff, #97d2e4);
    color:#084357; font-size: clamp(22px, 6.4vw, 28px);
    transform: rotateY(180deg);
  }
  .memFace.front img{ width: 78%; height: 78%; object-fit: contain; pointer-events:none; }
  .memInner.matched{ animation: pop .36s ease; }
  @keyframes pop{ 0%{ transform: rotateY(0deg) scale(1)} 50%{ transform: rotateY(0deg) scale(1.06)} 100%{ transform: rotateY(0deg) scale(1)} }
  .lives{ display:flex; gap:6px; align-items:center; font-size:clamp(18px,5.4vw,22px) }
  .lives .heart{ transition: .2s ease; }
  .lives .heart.lost{ opacity:.3; filter:grayscale(1); transform:scale(.92); }

  /* ===== 2048（アイス合成パズル） ===== */
  #scoop{display:none}
  .scoopHud{display:flex;gap:16px;justify-content:center;align-items:center;flex-wrap:wrap;font-weight:800;margin:8px 0}
  .scoopHud span{background:#ffffffcc;padding:8px 12px;border-radius:10px;box-shadow:0 6px 16px #00000012}
  .scoopBtns{display:flex;gap:10px}
  .scoopBoard{width:min(520px,92vw);margin:12px auto 0;position:relative}
  .scGrid{
    display:grid;grid-template-columns:repeat(4,1fr);gap:10px;
    background:#bde3ef;padding:10px;border-radius:14px;
  }
  .scGrid .cell{aspect-ratio:1/1;border-radius:10px;background:#e6f7fd}
  .scTiles{position:absolute;inset:0;display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:10px}
  .scTiles > .slot{ aspect-ratio: 1 / 1; }       /* ← 1マスの“枠” */
  .tile{
    width:100%; height:100%; border-radius:12px; display:grid; place-items:center;
    font-weight:900;text-align:center;line-height:1.1;
    box-shadow:0 10px 24px rgba(0,0,0,.12); user-select:none;
    animation: tileIn .18s ease;
    color:#083b48;font-size:clamp(12px,3.6vw,15px)
  }
  .tile b{display:block;font-size:clamp(18px,6vw,26px)}
  @keyframes tileIn{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
  .tile.merge{animation: mergePop .22s ease}
  @keyframes mergePop{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
  .t2{background:#fffdf5}.t4{background:#fff6da}
  .t8{background:#ffe1e9}.t16{background:#f6d7c7}
  .t32{background:#d8f0dc}.t64{background:#d7f0fb}
  .t128{background:#ffe9c2}.t256{background:#f7d9ff}
  .t512{background:#d9fff1}.t1024{background:#fff0c5}.t2048{background:#ffe7e7}
  .tileImg{ width:86%; height:86%; object-fit:contain; pointer-events:none; }
  #scPad{ position:sticky; bottom:env(safe-area-inset-bottom, 12px); display:none; margin-top:16px; }
  .pad{ width:180px; height:160px; margin:0 auto; position:relative; display:grid; place-items:center; }
  .pad button{
    position:absolute; width:56px; height:56px; border-radius:50%;
    border:none; background:#ffffffd8; box-shadow:0 8px 18px #00000018;
    font-size:22px; font-weight:900; color:#0c2a33; cursor:pointer;
  }
  .pad .up{top:0; left:50%; transform:translate(-50%,0)}
  .pad .down{bottom:0; left:50%; transform:translate(-50%,0)}
  .pad .left{left:0; top:50%; transform:translate(0,-50%)}
  .pad .right{right:0; top:50%; transform:translate(0,-50%)}

  /* ====== 2人対戦（共通UI） ====== */
  #versus, #ttt, #mem2, #c4{display:none}
  .vsBar{
    display:flex; gap:10px; justify-content:center; align-items:center;
    flex-wrap:wrap; margin:6px 0 10px;
  }
  .vsBar .side{
    display:flex; gap:8px; align-items:center; background:#ffffffcc;
    padding:6px 10px; border-radius:999px; box-shadow:0 6px 14px #00000012;
    font-weight:800;
  }
  .vsBar img{ width:28px; height:28px; border-radius:50%; object-fit:cover }
  .vsBar .mid{ font-weight:800; color:#0c2a33; }

  .vsPick{ display:grid; grid-template-columns:1fr 1fr; gap:14px; align-items:flex-start }
  .pickCol{ background:#ffffffcc; border-radius:14px; padding:10px; box-shadow:0 8px 18px #00000014 }
  .pickHead{ font-weight:800; margin:2px 0 8px }
  .charPick{ display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:10px }
  .charPick button{
    border:none; background:#fff; border-radius:12px; padding:8px; cursor:pointer;
    box-shadow:0 8px 18px #00000014; display:grid; place-items:center; gap:6px; font-weight:700
  }
  .charPick img{ width:76px; height:76px; object-fit:cover; border-radius:8px }
  .charPick button.selected{ outline:3px solid #10aee3 }

  /* 〇✕（3×3） */
  .tttBoard{
    width:min(520px, 92vw); margin:10px auto; display:grid; gap:8px;
    grid-template-columns:repeat(3,1fr);
    background:#bde3ef; padding:10px; border-radius:14px;
    background-image:url('stage3x3.png'); background-size:contain; background-position:center; background-repeat:no-repeat;
  }
  .tttCell{
    aspect-ratio:1/1; display:grid; place-items:center; border-radius:12px;
    background:#e6f7fd; font-size:clamp(32px,10vw,52px); font-weight:900; cursor:pointer;
    box-shadow:0 10px 22px #00000010;
  }

  /* 四目並べ（7×6） */
  .c4Board{
    position:relative;
    width:min(620px, 92vw); margin:10px auto; display:grid; grid-template-columns:repeat(7,1fr); gap:8px;
    background:#bde3ef; padding:10px; border-radius:14px;
    background-image:url('stage7x6.png'); background-size:contain; background-position:center; background-repeat:no-repeat;
  }
  .c4Cell{
    aspect-ratio:1/1; background:#e6f7fd; border-radius:50%; position:relative;
    box-shadow:inset 0 0 0 6px #cfeef8, 0 10px 20px #00000014;
  }
  .c4Cell .disc{
    position:absolute; inset:6px; border-radius:50%; box-shadow:0 8px 18px #00000020;
  }
  .disc.p1{ background:#10aee3 } /* P1色 */
  .disc.p2{ background:#0da66e } /* P2色 */
</style>
</head>

<body>
<div class="wrap">

  <!-- ============= タイトル画面 ============= -->
  <div class="container" id="title">
    <div class="hero">
      <span class="pill" id="titlePill">めちゃつよっ！</span>
      <h2>ボリューミー店長との<br>じゃんけん対決！</h2>

      <!-- 店長画像（最初は挑発ポーズ）。諦める→やっぱ挑戦で差し替え -->
      <img id="titleImg" class="title-illus" src="title-start2.png" alt="店長ポーズ">
      <div id="speech" class="speech">俺の強さに怖気づいたかっ！</div>

      <!-- じゃんけんへ / 諦める→「挑戦する」に一度だけ変身 -->
      <div class="btnrow">
        <button class="btn primary" id="btnStart">挑戦する</button>
        <button class="btn ghost"   id="btnQuit"  data-mode="quit">あきらめる</button>
      </div>

      <!-- ほかのゲームへ直行 -->
      <div class="btnrow">
        <button class="btn ghost" id="btnMem">神経衰弱で遊ぶ</button>
      </div>
      <div class="btnrow">
        <button class="btn ghost" id="btnScoop">合成パズルで遊ぶ</button>
      </div>
      <!-- 2人対戦 -->
      <div class="btnrow">
        <button class="btn ghost" id="btnVs">2人で遊ぶ</button>
      </div>

      <p class="title-note">めちゃつよ店長に勝利しよう！</p>
    </div>
  </div>

  <!-- ============= じゃんけん ============= -->
  <div class="container" id="game">
    <div class="topRow">
      <div class="frameBox">
        <img id="bossHandImg" class="bossHandImg" src="rock2.png" alt="店長の手">
      </div>
      <img class="bossPic" src="boss2.png" alt="店長">
    </div>

    <h1>～店長とジャンケン勝負～</h1>
    <p class="sub">先に3回勝った方が勝ち！</p>

    <div class="score" id="score">あなた 0 - 店長 0</div>
    <div class="message" id="message">手を選んでね！</div>

    <div class="hands" id="hands">
      <button class="handBtn" data-hand="rock"     aria-label="グー">✊</button>
      <button class="handBtn" data-hand="scissors" aria-label="チョキ">✌️</button>
      <button class="handBtn" data-hand="paper"    aria-label="パー">✋</button>
    </div>

    <div class="resultCard" id="resultCard"></div>
    <div class="restartRow" id="restartRow">
      <button class="btn ghost" id="restartBtn">再挑戦</button>
    </div>

    <div class="btnrow" style="margin-top:12px">
      <button class="btn ghost" id="backToTitle1">タイトルへ戻る</button>
    </div>
  </div>

  <!-- ============= 神経衰弱（ソロ：ライフ3＋難易度） ============= -->
  <div class="container" id="memory">
    <h1>〜神経衰弱〜</h1>
    <p class="sub">同じアイスを2枚めくってペアを作ろう！</p>

    <div class="memDiff">
      <button class="btn primary" id="memEasyBtn">やさしい（4ペア）</button>
      <button class="btn ghost"   id="memHardBtn">むずかしい（6ペア）</button>
    </div>

    <div class="memHud" id="memHud" style="display:none">
      <span id="memMoves">手数: 0</span>
      <span id="memPairs">ペア: 0 / 4</span>
      <span class="lives" id="memLives" title="ライフ">
        <span class="heart">🩵</span>
        <span class="heart">🩵</span>
        <span class="heart">🩵</span>
      </span>
      <button class="btn ghost" id="memRetry">もう一回</button>
    </div>

    <div class="memGrid" id="memGrid" aria-label="カードの場"></div>
    <div class="resultCard" id="memResult" style="display:none; margin-top:14px"></div>

    <div class="btnrow" style="margin-top:10px">
      <button class="btn ghost" id="memBack">タイトルへ戻る</button>
    </div>
  </div>

  <!-- ============= 2048（アイス合成パズル） ============= -->
  <div class="container" id="scoop">
    <h1>〜2048パズル〜</h1>
    <p class="sub">同じ数字を合体させて高スコアを目指そう</p>

    <div class="scoopHud">
      <span id="scScore">スコア: 0</span>
      <span id="scBest">ベスト: 0</span>
      <div class="scoopBtns">
        <button class="btn ghost" id="scUndo">1手戻る</button>
        <button class="btn ghost" id="scRetry">もう一回</button>
      </div>
    </div>

    <div class="scoopBoard">
      <div class="scGrid" id="scGridBg"></div>
      <div class="scTiles" id="scTiles"></div>
    </div>

    <div class="resultCard" id="scResult" style="display:none; margin-top:14px"></div>

    <div id="scPad">
      <div class="pad">
        <button class="up"    aria-label="上へ">↑</button>
        <button class="left"  aria-label="左へ">←</button>
        <button class="right" aria-label="右へ">→</button>
        <button class="down"  aria-label="下へ">↓</button>
      </div>
    </div>

    <div class="btnrow" style="margin-top:10px">
      <button class="btn ghost" id="scBack">タイトルへ戻る</button>
    </div>
  </div>

  <!-- ============= 2人対戦：キャラ選択＆メニュー ============= -->
  <div class="container" id="versus">
    <h1>2人で遊ぶ</h1>
    <!-- Step1: キャラ選択 -->
    <div id="vsStepPick">
      <p class="sub">プレイヤー1と2のキャラを選んでね（同じキャラもOK！）</p>
      <div class="vsPick">
        <div class="pickCol">
          <div class="pickHead">プレイヤー1</div>
          <div class="charPick" id="pick1"></div>
        </div>
        <div class="pickCol">
          <div class="pickHead">プレイヤー2</div>
          <div class="charPick" id="pick2"></div>
        </div>
      </div>
      <div id="vsHint" class="title-note" style="display:none">「俺が2人！？」（2Pは冬服になるよ）</div>
      <div class="btnrow">
        <button class="btn primary" id="vsGoGames" disabled>ゲームを選ぶ</button>
      </div>
    </div>

    <!-- Step2: ゲーム選択 -->
    <div id="vsStepGames" style="display:none">
      <h1 style="margin-top:6px">対戦ゲームを選ぶ</h1>
      <div class="btnrow">
        <button class="btn primary" id="vsPlayTTT">◯✖️ゲーム（3×3）</button>
        <button class="btn ghost"   id="vsPlayMem">神経衰弱（7種類）</button>
        <button class="btn ghost"   id="vsPlayC4">コイン落とし（四目並べ）</button>
      </div>
      <div class="btnrow">
        <button class="btn ghost" id="vsRePick">キャラを選び直す</button>
      </div>
    </div>

    <div class="btnrow">
      <button class="btn ghost" id="vsBackTitle">タイトルへ戻る</button>
    </div>
  </div>

  <!-- ============= VS: 〇✕ゲーム ============= -->
  <div class="container" id="ttt">
    <h1>〜◯✖️ゲーム〜</h1>
    <div class="vsBar">
      <div class="side">
        <img id="tttP1Img" alt=""><span id="tttP1Name"></span>
      </div>
      <div class="mid" id="tttTurn">P1のターン</div>
      <div class="side">
        <img id="tttP2Img" alt=""><span id="tttP2Name"></span>
      </div>
    </div>
    <div class="tttBoard" id="tttBoard" aria-label="3x3 board"></div>
    <div class="resultCard" id="tttResult" style="display:none;margin-top:12px"></div>
    <div class="btnrow" style="margin-top:10px">
      <button class="btn ghost" id="tttAgain">もう一回</button>
      <button class="btn ghost" id="tttToMenu">他のゲームへ</button>
      <button class="btn ghost" id="tttToTitle">タイトルへ戻る</button>
    </div>
  </div>

  <!-- ============= VS: 神経衰弱（7種類×2=14枚） ============= -->
  <div class="container" id="mem2">
    <h1>〜神経衰弱（対戦）〜</h1>
    <div class="vsBar">
      <div class="side">
        <img id="mem2P1Img" alt=""><span id="mem2P1Name"></span><b id="mem2Score1" style="margin-left:6px">0</b>
      </div>
      <div class="mid" id="mem2Turn">P1のターン</div>
      <div class="side">
        <img id="mem2P2Img" alt=""><span id="mem2P2Name"></span><b id="mem2Score2" style="margin-left:6px">0</b>
      </div>
    </div>
    <div class="memGrid" id="mem2Grid" aria-label="カードの場"></div>
    <div class="resultCard" id="mem2Result" style="display:none;margin-top:12px"></div>
    <div class="btnrow" style="margin-top:10px">
      <button class="btn ghost" id="mem2Again">もう一回</button>
      <button class="btn ghost" id="mem2ToMenu">他のゲームへ</button>
      <button class="btn ghost" id="mem2ToTitle">タイトルへ戻る</button>
    </div>
  </div>

  <!-- ============= VS: 四目並べ（7×6） ============= -->
  <div class="container" id="c4">
    <h1>〜コイン落とし（四目並べ）〜</h1>
    <div class="vsBar">
      <div class="side">
        <img id="c4P1Img" alt=""><span id="c4P1Name"></span>
      </div>
      <div class="mid" id="c4Turn">P1のターン</div>
      <div class="side">
        <img id="c4P2Img" alt=""><span id="c4P2Name"></span>
      </div>
    </div>
    <div class="c4Board" id="c4Board" aria-label="7x6 board"></div>
    <div class="resultCard" id="c4Result" style="display:none;margin-top:12px"></div>
    <div class="btnrow" style="margin-top:10px">
      <button class="btn ghost" id="c4Again">もう一回</button>
      <button class="btn ghost" id="c4ToMenu">他のゲームへ</button>
      <button class="btn ghost" id="c4ToTitle">タイトルへ戻る</button>
    </div>
  </div>

</div><!-- /.wrap -->

<!-- =========================
     スクリプト（挙動のロジック）
     ========================= -->
<script>
  /* ---------- 画面参照 ---------- */
  const titleView = document.getElementById('title');
  const gameView  = document.getElementById('game');
  const memView   = document.getElementById('memory');
  const scoopView = document.getElementById('scoop');
  const vsView    = document.getElementById('versus');
  const tttView   = document.getElementById('ttt');
  const mem2View  = document.getElementById('mem2');
  const c4View    = document.getElementById('c4');

  /* ---------- タイトルのボタン ---------- */
  const titleImg  = document.getElementById('titleImg');
  const speech    = document.getElementById('speech');
  const btnStart  = document.getElementById('btnStart');
  const btnQuit   = document.getElementById('btnQuit');
  const btnMem    = document.getElementById('btnMem');
  const btnScoop  = document.getElementById('btnScoop');
  const btnVs     = document.getElementById('btnVs');

  btnQuit.addEventListener('click', () => {
    if (btnQuit.dataset.mode === 'quit') {
      speech.style.display = 'block';
      titleImg.src = 'title-quit2.png';
      btnQuit.textContent = '挑戦する';
      btnQuit.dataset.mode = 'start';
      btnQuit.classList.remove('ghost');
      btnQuit.classList.add('primary');
    } else {
      startGame(); // 次は本当に開始
    }
  });
  btnStart.addEventListener('click', startGame);
  btnMem.addEventListener('click', showMemoryMenu);
  btnScoop.addEventListener('click', showScoop);
  btnVs.addEventListener('click', showVs);

  function hideAll(){
    [titleView, gameView, memView, scoopView, vsView, tttView, mem2View, c4View].forEach(v=>v.style.display='none');
  }
  function showTitle(){
    hideAll(); titleView.style.display='block';
    speech.style.display='none'; titleImg.src = 'title-start2.png';
    btnQuit.textContent = 'あきらめる'; btnQuit.dataset.mode = 'quit';
    btnQuit.classList.add('ghost'); btnQuit.classList.remove('primary');
    document.getElementById('scPad').style.display='none'; // 2048パッドを隠す
    window.scrollTo({top:0, behavior:'smooth'});
  }

  /* =================================================
     じゃんけん（店長やや強め）
     ================================================= */
  function startGame(){
    hideAll(); gameView.style.display='block';
    resetGame();
    window.scrollTo({top:0,behavior:'smooth'});
  }
  const WIN_TARGET = 3;
  const BOSS_EDGE  = 0.70;

  const scoreEl    = document.getElementById('score');
  const messageEl  = document.getElementById('message');
  const handsWrap  = document.getElementById('hands');
  const resultCard = document.getElementById('resultCard');
  const restartRow = document.getElementById('restartRow');
  const bossHandImg= document.getElementById('bossHandImg');

  let score = { you:0, boss:0 };
  const IMG    = { rock:'rock2.png', scissors:'scissors2.png', paper:'paper2.png' };
  const WINMAP = { rock:'scissors', scissors:'paper', paper:'rock' };

  function resetGame(){
    score.you = 0; score.boss = 0;
    updateScore();
    messageEl.textContent = '手を選んでね！';
    bossHandImg.src = IMG.rock;
    resultCard.style.display = 'none'; restartRow.style.display = 'none';
    handsWrap.style.display = 'flex';
  }
  function updateScore(){ scoreEl.textContent = `あなた ${score.you} - 店長 ${score.boss}`; }
  function bossPick(player){
    const beat = ({rock:'paper', paper:'scissors', scissors:'rock'})[player]; // 店長が勝つ手
    const lose = WINMAP[player]; const tie  = player;
    if (Math.random() < BOSS_EDGE) return beat;
    return [lose, tie][Math.random()<0.5 ? 0 : 1];
  }
  function play(player){
    if (handsWrap.style.display === 'none') return;
    const boss = bossPick(player);
    bossHandImg.src = IMG[boss];
    if (player === boss){
      messageEl.textContent = 'あいこ！次の手を選んでね';
    }else if (WINMAP[player] === boss){
      score.you++; updateScore();
      messageEl.innerHTML = `<span class="win">あなたの勝ち！</span> 次の手を選んでね`;
    }else{
      score.boss++; updateScore();
      messageEl.innerHTML = `<span class="lose">店長の勝ち！</span> 次の手を選んでね`;
    }
    checkFinish();
  }
  function checkFinish(){
    if (score.you >= WIN_TARGET || score.boss >= WIN_TARGET){
      handsWrap.style.display = 'none';
      resultCard.style.display = 'block';
      restartRow.style.display = 'flex';
      if (score.you >= WIN_TARGET){
        resultCard.innerHTML = `<strong>🎉 あなたの勝ち！</strong><div style="margin-top:6px">おめでとう！</div>`;
      }else{
        resultCard.innerHTML = `<strong>👑 店長の勝ち！</strong><div style="margin-top:6px">また挑戦してね！</div>`;
      }
    }
  }
  document.querySelectorAll('.handBtn').forEach(b=>b.addEventListener('click', ()=>play(b.dataset.hand)));
  document.getElementById('restartBtn').addEventListener('click', resetGame);
  document.getElementById('backToTitle1').addEventListener('click', showTitle);

  /* =================================================
     神経衰弱（ソロ）
     ================================================= */
  const memGrid   = document.getElementById('memGrid');
  const memHud    = document.getElementById('memHud');
  const memMoves  = document.getElementById('memMoves');
  const memPairs  = document.getElementById('memPairs');
  const memRetry  = document.getElementById('memRetry');
  const memBack   = document.getElementById('memBack');
  const memResult = document.getElementById('memResult');
  const memLives  = document.getElementById('memLives');
  const memEasyBtn= document.getElementById('memEasyBtn');
  const memHardBtn= document.getElementById('memHardBtn');

  const MAX_LIVES = 3;
  let TYPES_COUNT = 4; // 4 or 6
  let memDeck = []; // {id}
  let first = null, second = null, lock = false;
  let pairs = 0, moves = 0;
  let lives = MAX_LIVES;
  let memOver = false;

  function showMemoryMenu(){
    hideAll(); memView.style.display='block';
    memHud.style.display = 'none'; memGrid.innerHTML = ''; memResult.style.display = 'none';
    window.scrollTo({top:0, behavior:'smooth'});
  }
  memEasyBtn.addEventListener('click', ()=> startMemory(4));
  memHardBtn.addEventListener('click', ()=> startMemory(6));

  function startMemory(types=4){
    TYPES_COUNT = types; buildMemDeck(); renderMem();
    pairs = 0; moves = 0; lock = false; first = second = null; memOver = false; lives = MAX_LIVES;
    updateMemHud(); renderLives(); memResult.style.display = 'none'; memHud.style.display = 'flex';
    window.scrollTo({top:0, behavior:'smooth'});
  }
  function updateMemHud(){ memMoves.textContent = `手数: ${moves}`; memPairs.textContent = `ペア: ${pairs} / ${TYPES_COUNT}`; }
  function renderLives(){ const hearts = memLives.querySelectorAll('.heart'); hearts.forEach((h,i)=> h.classList.toggle('lost', i >= lives)); }
  function buildMemDeck(){
    memDeck = []; for(let i=0;i<TYPES_COUNT;i++){ memDeck.push({id:i}); memDeck.push({id:i}); }
    for(let i=memDeck.length-1; i>0; i--){ const j = Math.floor(Math.random()*(i+1)); [memDeck[i], memDeck[j]] = [memDeck[j], memDeck[i]]; }
  }
  function renderMem(){
    memGrid.innerHTML = '';
    const ICE_SET = [
      { img:'ice1.png', emoji:'🍨', name:'プレーン' },
      { img:'ice2.png', emoji:'🍫', name:'チョコ' },
      { img:'ice3.png', emoji:'🍵', name:'そのぎ茶' },
      { img:'ice4.png', emoji:'🔔', name:'ちりんちりんくん' },
      { img:'ice5.png', emoji:'👨', name:'店長1' },
      { img:'ice6.png', emoji:'🧑', name:'店長2' }
    ];
    memDeck.forEach((card, idx)=>{
      const c = document.createElement('div'); c.className = 'memCard'; c.dataset.index = idx;
      const inner = document.createElement('div'); inner.className = 'memInner'; inner.setAttribute('role','button'); inner.setAttribute('aria-label','カードをめくる');
      const front = document.createElement('div'); front.className = 'memFace front';
      const img = document.createElement('img'); img.src = ICE_SET[card.id].img; img.alt = ICE_SET[card.id].name;
      const emoji = document.createElement('span'); emoji.textContent = ICE_SET[card.id].emoji; emoji.style.fontSize = 'clamp(32px, 10vw, 56px)';
      img.addEventListener('load', ()=> { emoji.style.display='none'; }); img.addEventListener('error',()=> { img.style.display='none'; });
      front.appendChild(img); front.appendChild(emoji);
      const back = document.createElement('div'); back.className = 'memFace back'; back.textContent = '🍨';
      inner.appendChild(front); inner.appendChild(back); c.appendChild(inner); memGrid.appendChild(c);
      c.addEventListener('click', ()=> flipMem(idx, inner));
    });
  }
  function flipMem(idx, innerEl){
    if (memOver || lock) return; if (innerEl.classList.contains('flipped')) return;
    innerEl.classList.add('flipped');
    if (!first){ first = { idx, id: memDeck[idx].id, el: innerEl }; navigator.vibrate?.(15); return; }
    second = { idx, id: memDeck[idx].id, el: innerEl }; lock = true; moves++; updateMemHud();
    if (first.id === second.id){
      setTimeout(()=>{
        first.el.classList.add('matched'); second.el.classList.add('matched');
        pairs++; updateMemHud(); first = second = null; lock = false;
        if (pairs >= TYPES_COUNT){ memOver = true; memResult.style.display = 'block'; memResult.innerHTML = `<strong>🎉 ぜんぶそろった！</strong><div style="margin-top:6px">おめでとう！</div>`; }
        navigator.vibrate?.([20,40,20]);
      }, 220);
    }else{
      lives = Math.max(0, lives - 1); renderLives();
      setTimeout(()=>{
        first.el.classList.remove('flipped'); second.el.classList.remove('flipped');
        first = second = null; lock = false; navigator.vibrate?.(30);
        if (lives <= 0 && !memOver){ memOver = true; memResult.style.display = 'block'; memResult.innerHTML = `<strong>💥 おしまい！</strong><div style="margin-top:6px">また挑戦してね！</div>`; }
      }, 700);
    }
  }
  memRetry.addEventListener('click', ()=> startMemory(TYPES_COUNT));
  memBack.addEventListener('click', showTitle);

  /* =================================================
     2048（アイス合成パズル）
     ================================================= */
  function showScoop(){
    hideAll(); scoopView.style.display='block'; setupScoop();
    document.getElementById('scPad').style.display = 'block';
    window.scrollTo({top:0,behavior:'smooth'});
  }
  document.getElementById('scBack').addEventListener('click', ()=>{ document.getElementById('scPad').style.display = 'none'; showTitle(); });

  const scGridBg = document.getElementById('scGridBg');
  const scTiles  = document.getElementById('scTiles');
  const scScore  = document.getElementById('scScore');
  const scBest   = document.getElementById('scBest');
  const scUndo   = document.getElementById('scUndo');
  const scRetry  = document.getElementById('scRetry');
  const scResult = document.getElementById('scResult');

  const IMAGE_LABEL = { 128:'屋台', 256:'アイス', 512:'店長', 1024:'店長キメポーズ', 2048:'社長' };

  let board = []; let scoreNow = 0; let best = Number(localStorage.getItem('scoop_best') || 0); let prevState = null;

  function setupScoop(){
    if (!scGridBg.childElementCount){ for(let i=0;i<16;i++){ const c=document.createElement('div'); c.className='cell'; scGridBg.appendChild(c); } }
    best = Number(localStorage.getItem('scoop_best') || 0);
    scoreNow = 0; board = new Array(16).fill(0); prevState=null;
    spawn(); spawn(); draw(); scResult.style.display='none';
  }
  function spawn(){ const zeros = board.map((v,i)=>v===0?i:null).filter(v=>v!==null); if (!zeros.length) return false; const pos = zeros[Math.floor(Math.random()*zeros.length)]; board[pos] = Math.random()<0.9 ? 2 : 4; return true; }
  function canMove(){ if (board.includes(0)) return true; for (let r=0;r<4;r++) for(let c=0;c<4;c++){ const i=r*4+c, v=board[i]; if (c<3 && board[i+1]===v) return true; if (r<3 && board[i+4]===v) return true; } return false; }
  function lineMove(line){ let arr = line.filter(v=>v!==0); let scoreGain = 0; for(let i=0;i<arr.length-1;i++){ if (arr[i]!==0 && arr[i]===arr[i+1]){ arr[i]*=2; scoreGain += arr[i]; arr[i+1]=0; i++; } } arr = arr.filter(v=>v!==0); while(arr.length<4) arr.push(0); return {line:arr, gain:scoreGain}; }
  function move(dir){
    const before = board.slice(); prevState = {board: before.slice(), score: scoreNow}; let totalGain = 0;
    if (dir==='L' || dir==='R'){
      for(let r=0;r<4;r++){ let row = board.slice(r*4, r*4+4); if (dir==='R') row.reverse(); const {line,gain} = lineMove(row); totalGain += gain; if (dir==='R') line.reverse(); for(let c=0;c<4;c++) board[r*4+c]=line[c]; }
    } else {
      for(let c=0;c<4;c++){ let col = [board[c],board[c+4],board[c+8],board[c+12]]; if (dir==='D') col.reverse(); const {line,gain} = lineMove(col); totalGain += gain; if (dir==='D') line.reverse(); [board[c],board[c+4],board[c+8],board[c+12]] = line; }
    }
    if (board.join('') === before.join('')){ prevState = null; return; }
    scoreNow += totalGain; if (scoreNow>best){ best=scoreNow; localStorage.setItem('scoop_best', String(best)); }
    spawn(); draw(); checkState();
  }
  function checkState(){
    const maxTile = Math.max(...board);
    if (maxTile >= 2048){ scResult.style.display='block'; scResult.innerHTML = `<strong>🎉 2048達成！${IMAGE_LABEL[2048] || ''}</strong><div style="margin-top:6px">おめでとう！</div>`; }
    else{ scResult.style.display='none'; }
    if (!canMove()){ scResult.style.display='block'; scResult.innerHTML = `<strong>💥 おしまい！</strong><div style="margin-top:6px">スコア ${scoreNow}（ベスト ${best}） また挑戦してね！</div>`; }
  }
  function draw(){
    scTiles.innerHTML = '';
    for (let i = 0; i < 16; i++){
      const slot = document.createElement('div'); slot.className = 'slot';
      const v = board[i];
      if (v){
        const t = document.createElement('div'); t.className = `tile t${v}`;
        if (v >= 128){
          const img = document.createElement('img'); img.className = 'tileImg'; img.src = `puzzle${v}.png`; img.alt = IMAGE_LABEL[v] || String(v);
          img.addEventListener('error', ()=>{ img.remove(); t.innerHTML = `<b>${v}</b>`; }); t.appendChild(img);
        } else { t.innerHTML = `<b>${v}</b>`; }
        slot.appendChild(t);
      }
      scTiles.appendChild(slot);
    }
    scScore.textContent = `スコア: ${scoreNow}`; scBest.textContent  = `ベスト: ${best}`;
  }
  window.addEventListener('keydown', (e)=>{ if (scoopView.style.display!=='block') return; const k=e.key; if (k==='ArrowLeft') move('L'); else if (k==='ArrowRight') move('R'); else if (k==='ArrowUp') move('U'); else if (k==='ArrowDown') move('D'); });
  let touchStartX=0, touchStartY=0;
  scTiles.addEventListener('touchstart', (e)=>{ const t=e.touches[0]; touchStartX=t.clientX; touchStartY=t.clientY; }, {passive:true});
  scTiles.addEventListener('touchend', (e)=>{ const t=e.changedTouches[0]; const dx=t.clientX-touchStartX, dy=t.clientY-touchStartY; const ax=Math.abs(dx), ay=Math.abs(dy), TH=24; if (ax<TH && ay<TH) return; if (ax>ay) move(dx>0?'R':'L'); else move(dy>0?'D':'U'); }, {passive:true});
  document.querySelector('#scPad .up')   .addEventListener('click', ()=>move('U'));
  document.querySelector('#scPad .down') .addEventListener('click', ()=>move('D'));
  document.querySelector('#scPad .left') .addEventListener('click', ()=>move('L'));
  document.querySelector('#scPad .right').addEventListener('click', ()=>move('R'));
  document.getElementById('scUndo').addEventListener('click', ()=>{ if (!prevState) return; board = prevState.board.slice(); scoreNow = prevState.score; prevState=null; draw(); scResult.style.display='none'; });
  document.getElementById('scRetry').addEventListener('click', setupScoop);

  /* =================================================
     2人対戦：キャラ定義・セリフ
     ================================================= */
  const CHAR = {
    1:   { id:1,    key:'character1',   name:'店長（夏）', short:'店長' },
    '1b':{ id:'1b', key:'character1-2', name:'店長（冬）', short:'店長', hidden:true }, // 隠し
    2:   { id:2,    key:'character2',   name:'店長の奥さん', short:'奥さん' },
    3:   { id:3,    key:'character3',   name:'バイトA君',  short:'バイト' },
    4:   { id:4,    key:'character4',   name:'社長',       short:'社長' },
  };
  const LINES = {
    default:{ win:'勝った！',                      lose:'負けちゃった…' },
    manager:{ win:'俺に勝とうなんて100年早い！',   lose:'いやーん！' },
    wife:   { win:'負けないわよ！',                lose:'今回は譲るわ…' },
    part:   { win:'やったっす！',                  lose:'マジか…' },
    ceo:    { win:'私が1番よ！',                   lose:'あんた減給ね…' },
    mirror: { win:'俺が本物の店長だ！',             lose:'俺に負けた…' },
  };
  function keyFromId(id){
    if (id===1 || id==='1') return 'manager';
    if (id==='1b') return 'manager';
    if (id===2) return 'wife';
    if (id===3) return 'part';
    if (id===4) return 'ceo';
    return 'default';
  }

  /* =================================================
     2人対戦：キャラ選択 → ゲーム選択
     ================================================= */
  let VS = { p1:null, p2:null };
  document.getElementById('vsBackTitle').addEventListener('click', showTitle);
  document.getElementById('vsGoGames').addEventListener('click', ()=>{ document.getElementById('vsStepPick').style.display='none'; document.getElementById('vsStepGames').style.display='block'; });
  document.getElementById('vsRePick').addEventListener('click', ()=>{ document.getElementById('vsStepPick').style.display='block'; document.getElementById('vsStepGames').style.display='none'; });
  function showVs(){
    hideAll(); vsView.style.display='block';
    document.getElementById('vsStepPick').style.display='block';
    document.getElementById('vsStepGames').style.display='none';
    VS = {p1:null,p2:null}; renderPickGrid('pick1','p1'); renderPickGrid('pick2','p2');
    document.getElementById('vsGoGames').disabled = true; document.getElementById('vsHint').style.display='none';
    window.scrollTo({top:0,behavior:'smooth'});
  }
  function renderPickGrid(elId, side){
    const host = document.getElementById(elId); host.innerHTML='';
    [1,2,3,4].forEach(id=>{
      const btn = document.createElement('button');
      const img = document.createElement('img'); img.src = `${CHAR[id].key}.png`; img.alt = CHAR[id].name;
      img.addEventListener('error', ()=>{ img.style.display='none'; btn.style.padding='16px'; btn.textContent = CHAR[id].short; });
      const label = document.createElement('span'); label.textContent = CHAR[id].name;
      btn.appendChild(img); btn.appendChild(label);
      btn.addEventListener('click', ()=>{
        host.querySelectorAll('button').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected'); VS[side] = id;
        if (VS.p1===1 && VS.p2===1){ VS.p2='1b'; document.getElementById('vsHint').style.display='block'; }
        else{ document.getElementById('vsHint').style.display='none'; }
        document.getElementById('vsGoGames').disabled = !(VS.p1 && VS.p2);
      });
      host.appendChild(btn);
    });
  }
  function setVsBar(p1ImgId, p1NameId, p2ImgId, p2NameId){
    const p1 = VS.p1, p2 = VS.p2;
    const p1Img = document.getElementById(p1ImgId), p2Img = document.getElementById(p2ImgId);
    const p1Name= document.getElementById(p1NameId), p2Name= document.getElementById(p2NameId);
    if (p1Img){ p1Img.src = `${CHAR[p1].key}.png`; p1Img.alt = CHAR[p1].name; p1Img.addEventListener('error',()=>{ p1Img.style.display='none'; }); }
    if (p2Img){ p2Img.src = `${CHAR[p2].key}.png`; p2Img.alt = CHAR[p2].name; p2Img.addEventListener('error',()=>{ p2Img.style.display='none'; }); }
    if (p1Name) p1Name.textContent = CHAR[p1].short;
    if (p2Name) p2Name.textContent = CHAR[p2].short;
  }

  /* =================================================
     VS：〇✕ゲーム
     ================================================= */
  document.getElementById('vsPlayTTT').addEventListener('click', startTTT);
  document.getElementById('tttToMenu').addEventListener('click', ()=>{ tttView.style.display='none'; vsView.style.display='block'; });
  document.getElementById('tttToTitle').addEventListener('click', showTitle);
  document.getElementById('tttAgain').addEventListener('click', startTTT);

  function startTTT(){
    vsView.style.display='none'; tttView.style.display='block';
    setVsBar('tttP1Img','tttP1Name','tttP2Img','tttP2Name');
    document.getElementById('tttResult').style.display='none';
    const boardEl = document.getElementById('tttBoard'); boardEl.innerHTML='';
    let turn = 1; let board = Array(9).fill(0); updateTurn();
    for(let i=0;i<9;i++){
      const cell=document.createElement('div'); cell.className='tttCell';
      cell.addEventListener('click', ()=>{
        if (board[i]!==0) return;
        if (document.getElementById('tttResult').style.display==='block') return;
        board[i] = turn; cell.textContent = (turn===1?'◯':'✕');
        const w = tttWinner(board);
        if (w){ showResult(w); }else if (!board.includes(0)){ showResult(0); }else{ turn = 3 - turn; updateTurn(); }
      });
      boardEl.appendChild(cell);
    }
    function updateTurn(){ document.getElementById('tttTurn').textContent = (turn===1?'P1':'P2')+'のターン'; }
    function showResult(w){
      const r=document.getElementById('tttResult'); r.style.display='block';
      if (w===0){ r.innerHTML = '<strong>引き分け！</strong>'; return; }
      const winner = (w===1?VS.p1:VS.p2), loser = (w===1?VS.p2:VS.p1);
      const mirror = ((winner===1||winner==='1b') && (loser===1||loser==='1b'));
      const winLine  = mirror ? LINES.mirror.win  : LINES[keyFromId(winner)].win;
      const loseLine = mirror ? LINES.mirror.lose : LINES[keyFromId(loser)].lose;
      r.innerHTML = `<strong>🎉 ${w===1?'P1':'P2'}の勝ち！</strong><div style="margin-top:6px">${winLine}<br>${loseLine}</div>`;
    }
  }
  function tttWinner(b){
    const lines=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    for(const [a,c,d] of lines){ if(b[a]&&b[a]===b[c]&&b[a]===b[d]) return b[a]; }
    return 0;
  }

  /* =================================================
     VS：神経衰弱（7種類）
     ================================================= */
  document.getElementById('vsPlayMem').addEventListener('click', startMem2);
  document.getElementById('mem2ToMenu').addEventListener('click', ()=>{ mem2View.style.display='none'; vsView.style.display='block'; });
  document.getElementById('mem2ToTitle').addEventListener('click', showTitle);
  document.getElementById('mem2Again').addEventListener('click', startMem2);

  function startMem2(){
    vsView.style.display='none'; mem2View.style.display='block';
    setVsBar('mem2P1Img','mem2P1Name','mem2P2Img','mem2P2Name');
    document.getElementById('mem2Score1').textContent='0';
    document.getElementById('mem2Score2').textContent='0';
    document.getElementById('mem2Result').style.display='none';
    const grid = document.getElementById('mem2Grid'); grid.innerHTML='';
    const kinds = 7; let deck=[]; for(let i=0;i<kinds;i++){ deck.push(i); deck.push(i); }
    for(let i=deck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]]; }
    let turn=1, first=null, second=null, lock=false, score=[0,0]; updateTurn();
    deck.forEach((id, idx)=>{
      const outer = document.createElement('div'); outer.className='memCard';
      const inner = document.createElement('div'); inner.className='memInner'; inner.setAttribute('role','button');
      const front = document.createElement('div'); front.className='memFace front';
      const back  = document.createElement('div'); back.className='memFace back'; back.textContent='🍨';
      const img   = document.createElement('img'); img.src=`ice${id+1}.png`; img.alt=`ice${id+1}`;
      const span  = document.createElement('span'); span.textContent='🍦'; span.style.fontSize='clamp(32px,10vw,56px)';
      img.addEventListener('load', ()=>{ span.style.display='none'; }); img.addEventListener('error',()=>{ img.style.display='none'; });
      front.appendChild(img); front.appendChild(span); inner.appendChild(front); inner.appendChild(back); outer.appendChild(inner); grid.appendChild(outer);
      outer.addEventListener('click', ()=>{
        if (lock || inner.classList.contains('flipped')) return;
        inner.classList.add('flipped');
        if (!first){ first={idx,id,el:inner}; return; }
        second={idx,id,el:inner}; lock=true;
        if (first.id===second.id){
          setTimeout(()=>{
            first.el.classList.add('matched'); second.el.classList.add('matched');
            score[turn-1]++; document.getElementById(turn===1?'mem2Score1':'mem2Score2').textContent=String(score[turn-1]);
            first=second=null; lock=false;
            if (score[0]+score[1]===kinds){
              const r=document.getElementById('mem2Result'); r.style.display='block';
              const w = score[0]===score[1]?0 : (score[0]>score[1]?1:2);
              r.innerHTML = w===0 ? '<strong>引き分け！</strong>' : `<strong>🎉 P${w}の勝ち！</strong>`;
            }
          }, 220);
        }else{
          setTimeout(()=>{
            first.el.classList.remove('flipped'); second.el.classList.remove('flipped');
            first=second=null; lock=false; turn=3-turn; updateTurn();
          }, 650);
        }
      });
    });
    function updateTurn(){ document.getElementById('mem2Turn').textContent = (turn===1?'P1':'P2')+'のターン'; }
  }

  /* =================================================
     VS：四目並べ（7×6）
     ================================================= */
  document.getElementById('vsPlayC4').addEventListener('click', startC4);
  document.getElementById('c4ToMenu').addEventListener('click', ()=>{ c4View.style.display='none'; vsView.style.display='block'; });
  document.getElementById('c4ToTitle').addEventListener('click', showTitle);
  document.getElementById('c4Again').addEventListener('click', startC4);

  function startC4(){
    vsView.style.display='none'; c4View.style.display='block';
    setVsBar('c4P1Img','c4P1Name','c4P2Img','c4P2Name');
    document.getElementById('c4Result').style.display='none';
    const W=7, H=6;
    const boardEl = document.getElementById('c4Board'); boardEl.innerHTML='';
    let grid=[...Array(H)].map(()=>Array(W).fill(0));
    let turn=1, over=false;
    updateTurn();

    // 盤面セルを並べる
    const cells=[];
    for(let r=0;r<H;r++){
      for(let c=0;c<W;c++){
        const cell=document.createElement('div'); cell.className='c4Cell'; cell.dataset.r=r; cell.dataset.c=c;
        cells.push(cell); boardEl.appendChild(cell);
      }
    }

    // クリックでコインを落とす
    boardEl.addEventListener('click', (e)=>{
      if (over) return;
      const target = e.target.closest('.c4Cell'); if (!target) return;
      const c = Number(target.dataset.c);

      // 下から空きを探す
      let r=H-1; while(r>=0 && grid[r][c]!==0) r--;
      if (r<0) return; // その列は満杯

      grid[r][c] = turn; renderDiscs();

      const w = c4Winner(grid);
      if (w){
        over = true;
        const winner = (w===1?VS.p1:VS.p2), loser = (w===1?VS.p2:VS.p1);
        const mirror = ((winner===1||winner==='1b') && (loser===1||loser==='1b'));
        const winLine  = mirror ? LINES.mirror.win  : LINES[keyFromId(winner)].win;
        const loseLine = mirror ? LINES.mirror.lose : LINES[keyFromId(loser)].lose;
        const rEl = document.getElementById('c4Result');
        rEl.style.display='block';
        rEl.innerHTML = `<strong>🎉 ${w===1?'P1':'P2'}の勝ち！</strong><div style="margin-top:6px">${winLine}<br>${loseLine}</div>`;
        return;
      }
      if (c4Full(grid)){ over=true; const rEl=document.getElementById('c4Result'); rEl.style.display='block'; rEl.innerHTML='<strong>引き分け！</strong>'; return; }

      // ターン交代
      turn = 3 - turn; updateTurn();
    });

    function renderDiscs(){
      cells.forEach((cell)=>{
        cell.innerHTML=''; const r=Number(cell.dataset.r), c=Number(cell.dataset.c);
        const v = grid[r][c]; if (!v) return;
        const d = document.createElement('div'); d.className = `disc p${v}`; cell.appendChild(d);
      });
    }
    function updateTurn(){ document.getElementById('c4Turn').textContent = (turn===1?'P1':'P2')+'のターン'; }
  }

  function c4Full(g){ for(let r=0;r<g.length;r++) for(let c=0;c<g[0].length;c++) if(g[r][c]===0) return false; return true; }
  function c4Winner(g){
    const H=g.length, W=g[0].length;
    const dirs=[[0,1],[1,0],[1,1],[1,-1]]; // 横・縦・斜め2方向
    for(let r=0;r<H;r++){
      for(let c=0;c<W;c++){
        const v=g[r][c]; if (!v) continue;
        for(const [dr,dc] of dirs){
          let ok=true;
          for(let k=1;k<4;k++){
            const nr=r+dr*k, nc=c+dc*k; if(nr<0||nr>=H||nc<0||nc>=W||g[nr][nc]!==v){ ok=false; break; }
          }
          if (ok) return v; // 4連
        }
      }
    }
    return 0;
  }
</script>
</body>
</html>
